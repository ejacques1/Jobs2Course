<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jobs2Course - Turn Your Job Into AI Efficiency Strategies</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #1f2937;
            background: linear-gradient(135deg, #eff6ff 0%, #ffffff 50%, #faf5ff 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        header {
            padding: 2rem 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .logo {
            font-size: 2rem;
            font-weight: bold;
            color: #1f2937;
        }
        
        .auth-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .usage-info {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .auth-btn {
            background: #3b82f6;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: none;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            text-decoration: none;
            display: inline-block;
        }
        
        .auth-btn:hover {
            background: #2563eb;
        }
        
        .auth-btn.secondary {
            background: transparent;
            color: #3b82f6;
            border: 1px solid #3b82f6;
        }
        
        .auth-btn.secondary:hover {
            background: #eff6ff;
        }
        
        main {
            padding: 2rem 0;
        }
        
        .hero {
            text-align: center;
            margin-bottom: 3rem;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .hero h1 {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }
        
        .hero .highlight {
            color: #3b82f6;
        }
        
        .hero p {
            font-size: 1.25rem;
            color: #6b7280;
            margin-bottom: 2rem;
        }
        
        .form-container {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            margin-bottom: 3rem;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        
        .required {
            color: #ef4444;
        }
        
        select, input, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        
        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .duties-field {
            position: relative;
        }
        
        .duties-field textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .char-counter {
            position: absolute;
            bottom: 0.5rem;
            right: 0.75rem;
            font-size: 0.75rem;
            color: #6b7280;
            background: white;
            padding: 0.25rem;
        }
        
        .analyze-btn {
            width: 100%;
            background: #3b82f6;
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            border: none;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .analyze-btn:hover {
            background: #2563eb;
        }
        
        .analyze-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-top: 3rem;
        }
        
        .feature-card {
            text-align: center;
            padding: 1.5rem;
        }
        
        .feature-icon {
            width: 4rem;
            height: 4rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 2rem;
        }
        
        .feature-icon.level1 { background: #dbeafe; }
        .feature-icon.level3 { background: #dcfce7; }
        
        .feature-card h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .results {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .results-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .results-header h2 {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .back-btn {
            margin-top: 1rem;
            color: #3b82f6;
            background: none;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            text-decoration: underline;
        }
        
        .strategy-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 2rem;
        }
        
        .strategy-header {
            background: #f9fafb;
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .strategy-content {
            padding: 1.5rem;
        }
        
        .level-card {
            border-radius: 0.5rem;
            padding: 1.5rem;
            border: 2px solid #bfdbfe;
            background: #eff6ff;
            margin-bottom: 1rem;
        }
        
        .level-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        
        .level-header h4 {
            font-weight: 600;
        }
        
        .gain-badge {
            font-size: 0.875rem;
            font-weight: 500;
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }
        
        .quick-start-btn {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid #3b82f6;
            color: #3b82f6;
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            margin-top: 0.75rem;
            transition: all 0.2s;
            width: 100%;
        }
        
        .quick-start-btn:hover {
            background: rgba(59, 130, 246, 0.2);
        }
        
        .quick-start-content {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 0.375rem;
            font-size: 0.8rem;
            line-height: 1.4;
            border-left: 3px solid #3b82f6;
            display: none;
        }
        
        .no-match-message {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .no-match-message h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #374151;
        }
        
        .no-match-message p {
            color: #6b7280;
            margin-bottom: 1.5rem;
        }
        
        .monetization-cta {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border-radius: 1rem;
            color: white;
            padding: 2rem;
            text-align: center;
            margin-top: 3rem;
        }
        
        .monetization-cta h3 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }
        
        .monetization-cta p {
            font-size: 1.125rem;
            margin-bottom: 1.5rem;
            opacity: 0.9;
        }
        
        .cta-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .cta-btn {
            background: white;
            color: #3b82f6;
            padding: 0.75rem 2rem;
            border-radius: 0.5rem;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }
        
        .cta-btn:hover {
            background: #f3f4f6;
            transform: translateY(-2px);
        }
        
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .auth-modal.show {
            display: flex;
        }
        
        .auth-content {
            background: white;
            border-radius: 1rem;
            max-width: 400px;
            width: 90%;
            padding: 2rem;
            position: relative;
        }
        
        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .modal-subtitle {
            color: #6b7280;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .google-signin-btn {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background: white;
            color: #1f2937;
            border: 1px solid #d1d5db;
            padding: 0.75rem;
            border-radius: 0.375rem;
            font-weight: 500;
            margin-bottom: 1rem;
            cursor: pointer;
        }
        
        .auth-toggle {
            text-align: center;
            margin-top: 1rem;
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .auth-toggle a {
            color: #3b82f6;
            text-decoration: none;
            cursor: pointer;
        }
        
        .error-message {
            background: #fee2e2;
            color: #dc2626;
            padding: 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .success-message {
            background: #d1fae5;
            color: #065f46;
            padding: 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .spinner {
            width: 1.5rem;
            height: 1.5rem;
            border: 2px solid #ffffff;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .cta-buttons {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">Jobs2Course</div>
                <div class="auth-controls">
                    <div class="usage-info" id="usage-info">
                        <span id="usage-count">5 free analyses remaining</span>
                    </div>
                    <div id="auth-buttons">
                        <button class="auth-btn" id="login-btn" onclick="showAuthModal('login')">Sign In</button>
                        <button class="auth-btn secondary" id="signup-btn" onclick="showAuthModal('signup')">Sign Up</button>
                    </div>
                    <div id="user-menu" class="hidden">
                        <span id="user-email"></span>
                        <button class="auth-btn" id="logout-btn" onclick="handleLogout()">Sign Out</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <!-- Main Form Section -->
        <div id="form-section">
            <div class="hero">
                <h1>Turn Your Job Into <span class="highlight">AI-Powered Efficiency</span></h1>
                <p>Describe what you actually do at work, and get personalized strategies to boost your productivity by 20-70%. Discover how to turn your expertise into a profitable course.</p>
            </div>

            <div class="form-container">
                <form id="job-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="industry">Industry <span class="required">*</span></label>
                            <select id="industry" required>
                                <option value="">Select your industry</option>
                                <option value="healthcare">Healthcare</option>
                                <option value="education">Education</option>
                                <option value="business">Business & Marketing</option>
                                <option value="technology">Technology</option>
                                <option value="finance">Finance & Banking</option>
                                <option value="retail">Retail & Sales</option>
                                <option value="other">Other</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="jobTitle">Job Title <span class="required">*</span></label>
                            <input type="text" id="jobTitle" required placeholder="e.g., Registered Nurse, Sales Manager, Teacher">
                        </div>
                    </div>

                    <div class="form-group duties-field">
                        <label for="jobDuties">What do you actually do in your job? <span class="required">*</span></label>
                        <textarea 
                            id="jobDuties" 
                            required 
                            placeholder="Describe your main responsibilities, daily tasks, and workflows. Be specific about what takes most of your time. For example: 'I spend 3 hours daily documenting patient care, 2 hours in meetings with families, 1 hour coordinating with doctors...'"
                            maxlength="2000"
                        ></textarea>
                        <div class="char-counter">
                            <span id="char-count">0</span>/2000 characters
                        </div>
                    </div>

                    <button type="submit" class="analyze-btn" id="analyze-btn">
                        <span>Analyze My Job & Get Efficiency Strategies</span>
                    </button>
                </form>
            </div>

            <div class="features">
                <div class="feature-card">
                    <div style="font-size: 2rem; font-weight: bold; color: #3b82f6; margin-bottom: 1rem;">JOBS</div>
                    <div class="feature-icon level1">⚡</div>
                    <h3>AI-Powered Analysis</h3>
                    <p>Get personalized efficiency strategies tailored to your specific role and industry</p>
                </div>
                <div class="feature-card">
                    <div style="font-size: 2rem; font-weight: bold; color: #3b82f6; margin-bottom: 1rem;">COURSES</div>
                    <div class="feature-icon level3">📈</div>
                    <h3>Monetize Your Expertise</h3>
                    <p>Turn your job efficiency discoveries into teachable online courses</p>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="hidden">
            <div class="results">
                <div class="results-header">
                    <h2 id="results-title">Your AI Efficiency Analysis</h2>
                    <p id="results-subtitle">Personalized strategies based on your job duties</p>
                    <button class="back-btn" id="back-btn">← Analyze Another Job</button>
                </div>

                <div id="strategies-container">
                    <!-- Dynamic content will be inserted here -->
                </div>

                <div class="monetization-cta" style="display: none;">
                    <h3 id="monetization-title">You've unlocked efficiency improvements!</h3>
                    <p id="monetization-text">Imagine turning these strategies into modules of a $197 course. Your expertise combined with these AI workflows could help thousands of professionals in your field.</p>
                    <div class="cta-buttons">
                        <a href="https://www.erinjacques.com/jobsimprovements" target="_blank" class="cta-btn" id="waitlist-btn">Join Course Creator Waitlist</a>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Authentication Modal -->
    <div id="auth-modal" class="auth-modal">
        <div class="auth-content">
            <button class="modal-close" onclick="hideAuthModal()">&times;</button>
            <div id="auth-form-container">
                <div class="modal-title" id="modal-title">Get Unlimited Access</div>
                <div class="modal-subtitle" id="modal-subtitle">Sign up for unlimited job analyses and advanced features</div>
                <div id="auth-messages"></div>
                <form id="auth-form" class="auth-form">
                    <button type="button" class="google-signin-btn" onclick="handleGoogleSignIn()">
                        <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 002.38-5.88c0-.57-.05-.66-.15-1.18z"/><path fill="#34A853" d="M8.98 16c2.16 0 3.97-.72 5.3-1.94l-2.6-2.04a4.8 4.8 0 01-7.18-2.53H1.83v2.07A8 8 0 008.98 16z"/><path fill="#FBBC04" d="M4.5 9.49a4.8 4.8 0 010-3.07V4.35H1.83a8 8 0 000 7.28z"/><path fill="#EA4335" d="M8.98 4.72c1.16 0 2.23.4 3.06 1.2l2.3-2.3A8 8 0 001.83 6.42L4.5 8.49a4.77 4.77 0 014.48-3.77z"/></svg>
                        Continue with Google
                    </button>
                    
                    <div style="text-align: center; margin: 1rem 0; color: #6b7280; font-size: 0.875rem;">
                        or
                    </div>
                    
                    <input type="email" id="auth-email" placeholder="Your email address" required>
                    <input type="password" id="auth-password" placeholder="Password (min 6 characters)" required minlength="6">
                    <button type="submit" class="auth-btn" id="auth-submit" style="width: 100%;">
                        Continue Free Forever
                    </button>
                </form>
                <div class="auth-toggle" id="auth-toggle">
                    Already have an account? <a onclick="toggleAuthMode()">Sign in</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="job-library.js"></script>
    
    <script>
        // Configuration
        const APP_CONFIG = {
            supabase: {
                url: 'https://hrgxcgdpyoeurxbpcatn.supabase.co',
                anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhyZ3hjZ2RweW9ldXJ4YnBjYXRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzOTE4MDMsImV4cCI6MjA3MTk2NzgwM30.KY-1WEDpxfLwKFMS0fisRNZuJvMc50Ikn_P5qdOxGp0'
            },
            usage: {
                freeAnalyses: 5,
                resetPeriod: 24 * 60 * 60 * 1000
            }
        };

        // Task Categories for fallback matching
        const taskCategories = {
            'Documentation & Report Writing': {
                keywords: ['report', 'document', 'write', 'record', 'log', 'note', 'summary', 'memo', 'brief', 'paper', 'documentation', 'filing', 'paperwork', 'forms', 'chart', 'journal', 'transcript', 'minutes', 'proposal', 'presentation', 'draft']
            },
            'Data Analysis & Processing': {
                keywords: ['data', 'analyze', 'analysis', 'spreadsheet', 'excel', 'numbers', 'calculate', 'metrics', 'statistics', 'stats', 'kpi', 'dashboard', 'chart', 'graph', 'pivot', 'formula', 'database', 'sql', 'query', 'trend', 'forecast', 'budget', 'financial', 'analytics']
            },
            'Communication & Email Management': {
                keywords: ['email', 'communicate', 'call', 'phone', 'meeting', 'respond', 'follow up', 'contact', 'correspondence', 'message', 'reply', 'outreach', 'discussion', 'conference', 'zoom', 'teams', 'slack', 'chat', 'coordinate', 'liaise']
            },
            'Customer Service & Support': {
                keywords: ['customer', 'client', 'support', 'help', 'service', 'assist', 'resolve', 'issue', 'problem', 'complaint', 'inquiry', 'ticket', 'case', 'troubleshoot', 'satisfaction', 'feedback', 'escalation', 'follow-up', 'retention', 'relationship']
            }
        };

        // Initialize Supabase
        let supabase = null;
        try {
            supabase = window.supabase.createClient(APP_CONFIG.supabase.url, APP_CONFIG.supabase.anonKey);
        } catch (error) {
            console.log('Supabase not configured, running in demo mode');
        }

        // Application State
        let currentUser = null;
        let usageCount = 5;
        let currentAuthMode = 'signup';
        let currentAnalysis = null;
        let progressInterval = null;

        // DOM Elements
        const formSection = document.getElementById('form-section');
        const resultsSection = document.getElementById('results-section');
        const jobForm = document.getElementById('job-form');
        const analyzeBtn = document.getElementById('analyze-btn');
        const backBtn = document.getElementById('back-btn');
        const authModal = document.getElementById('auth-modal');
        const authForm = document.getElementById('auth-form');
        const charCount = document.getElementById('char-count');
        const jobDuties = document.getElementById('jobDuties');
        const authButtons = document.getElementById('auth-buttons');
        const userMenu = document.getElementById('user-menu');

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
        });

        async function initializeApp() {
            await loadUserSession();
            updateUI();
            
            if (supabase) {
                supabase.auth.onAuthStateChange((event, session) => {
                    if (session?.user) {
                        handleAuthSuccess(session.user);
                    } else {
                        handleAuthLogout();
                    }
                });
            }
        }

        async function loadUserSession() {
            if (supabase) {
                try {
                    const { data: { session } } = await supabase.auth.getSession();
                    if (session?.user) {
                        currentUser = session.user;
                        usageCount = 999;
                        return;
                    }
                } catch (error) {
                    console.log('Session check failed:', error);
                }
            }
            
            const savedUser = localStorage.getItem('jobs2course_user');
            const savedUsage = localStorage.getItem('jobs2course_usage');
            
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    usageCount = 999;
                } catch (error) {
                    localStorage.removeItem('jobs2course_user');
                }
            } else if (savedUsage) {
                usageCount = Math.max(0, parseInt(savedUsage));
            }
        }

        function setupEventListeners() {
            jobDuties.addEventListener('input', function() {
                charCount.textContent = this.value.length;
            });

            jobForm.addEventListener('submit', handleJobAnalysis);
            backBtn.addEventListener('click', showFormSection);
            authForm.addEventListener('submit', handleAuth);
            
            authModal.addEventListener('click', function(e) {
                if (e.target === authModal) hideAuthModal();
            });
        }

        function updateUI() {
            updateUsageDisplay();
            updateAuthControls();
        }

        function updateUsageDisplay() {
            const usageElement = document.getElementById('usage-count');
            if (currentUser) {
                usageElement.textContent = 'Unlimited analyses';
            } else {
                usageElement.textContent = `${usageCount} free analyses remaining`;
            }
        }

        function updateAuthControls() {
            if (currentUser) {
                authButtons.classList.add('hidden');
                userMenu.classList.remove('hidden');
                document.getElementById('user-email').textContent = currentUser.email;
            } else {
                authButtons.classList.remove('hidden');
                userMenu.classList.add('hidden');
            }
        }

        // Progress Indicators
        function showAnalysisLoading() {
            const messages = [
                "Analyzing your job duties...",
                "Identifying efficiency opportunities...",
                "Generating personalized strategies...",
                "Finalizing recommendations..."
            ];
            
            let currentMessage = 0;
            
            const updateMessage = () => {
                analyzeBtn.innerHTML = `<div class="spinner"></div> <span>${messages[currentMessage]}</span>`;
                currentMessage = (currentMessage + 1) % messages.length;
            };
            
            updateMessage();
            analyzeBtn.disabled = true;
            progressInterval = setInterval(updateMessage, 1500);
        }

        function hideAnalysisLoading() {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
            analyzeBtn.innerHTML = '<span>Analyze My Job & Get Efficiency Strategies</span>';
            analyzeBtn.disabled = false;
        }

        // Job Analysis - AI First with Fallback
        async function handleJobAnalysis(e) {
            e.preventDefault();
            
            const industry = document.getElementById('industry').value;
            const jobTitle = document.getElementById('jobTitle').value.trim();
            const duties = document.getElementById('jobDuties').value.trim();

            if (!industry || !jobTitle || !duties) {
                alert('Please fill in all required fields');
                return;
            }

            if (!currentUser && usageCount <= 0) {
                showAuthModal('signup');
                return;
            }

            showAnalysisLoading();

            try {
                const analysis = await analyzeJobDuties(industry, jobTitle, duties);
                
                if (!currentUser) {
                    usageCount--;
                    localStorage.setItem('jobs2course_usage', usageCount.toString());
                    updateUsageDisplay();
                }

                displayResults(analysis, jobTitle, industry);
                showResultsSection();
                
            } catch (error) {
                console.error('Analysis error:', error);
                alert('Analysis failed. Please try again.');
            } finally {
                hideAnalysisLoading();
            }
        }

        async function analyzeJobDuties(industry, jobTitle, duties) {
            try {
                // Try AI analysis first
                const { data, error } = await supabase.functions.invoke('enhance-job-analysis', {
                    body: { industry, jobTitle, duties }
                });

                if (error) throw error;

                // Parse AI response
                const aiResponse = data.choices[0].message.content;
                const parsed = JSON.parse(aiResponse);
                
                if (parsed.strategies && parsed.strategies.length > 0) {
                    return {
                        strategies: parsed.strategies.map(s => ({
                            title: s.title,
                            description: s.description,
                            tools: s.tools,
                            setupTime: s.setup_time,
                            weeklySavings: s.weekly_savings,
                            efficiencyGain: s.efficiency_gain,
                            steps: s.steps,
                            quickWin: s.quick_win
                        })),
                        source: 'ai',
                        industry,
                        jobTitle,
                        duties
                    };
                }
                
                throw new Error('AI response invalid');
                
            } catch (error) {
                console.log('AI failed, using fallback:', error);
                
                // Fallback to job library matching
                const fallbackStrategies = extractTasksFromDuties(duties);
                
                return {
                    strategies: fallbackStrategies,
                    source: 'fallback',
                    industry,
                    jobTitle,
                    duties,
                    noMatches: fallbackStrategies.length === 0
                };
            }
        }

        function extractTasksFromDuties(duties) {
            if (!duties || duties.trim().length === 0) return [];

            const inputText = duties.toLowerCase();
            const categoryScores = {};

            for (const [categoryName, categoryData] of Object.entries(taskCategories)) {
                let score = 0;
                const keywords = categoryData.keywords;
                
                for (const keyword of keywords) {
                    const regex = new RegExp(`\\b${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'gi');
                    const matches = (inputText.match(regex) || []).length;
                    score += matches;
                }
                
                if (score > 0) {
                    categoryScores[categoryName] = score;
                }
            }

            const sortedCategories = Object.entries(categoryScores)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 3)
                .map(([categoryName]) => ({
                    title: `AI Tools for ${categoryName}`,
                    description: `Use AI to streamline your ${categoryName.toLowerCase()} tasks and save significant time each week.`,
                    tools: "ChatGPT, Claude, or Gemini",
                    setupTime: "20-30 minutes",
                    weeklySavings: "2-4 hours per week",
                    efficiencyGain: "25%",
                    steps: [
                        "Identify repetitive tasks in this category",
                        "Create AI prompts for common scenarios",  
                        "Test and refine your prompts",
                        "Build templates for reuse"
                    ],
                    quickWin: "Start with one repetitive task and create an AI prompt for it today"
                }));

            return sortedCategories;
        }

        function displayResults(analysis, jobTitle, industry) {
            document.getElementById('results-title').textContent = 
                analysis.source === 'ai' ? 
                `AI Efficiency Analysis for ${jobTitle}` : 
                `Efficiency Strategies for ${jobTitle}`;
                
            document.getElementById('results-subtitle').textContent = 
                `${analysis.source === 'ai' ? 'AI-generated' : 'Curated'} strategies based on your ${industry} workflows`;
            
            const container = document.getElementById('strategies-container');
            
            if (analysis.noMatches) {
                container.innerHTML = `
                    <div class="no-match-message">
                        <h3>No Specific Matches Found</h3>
                        <p>We couldn't find specific efficiency strategies for your tasks, but we're working on expanding our coverage.</p>
                    </div>
                `;
            } else {
                container.innerHTML = analysis.strategies.map((strategy, index) => `
                    <div class="strategy-card">
                        <div class="strategy-header">
                            <h3>${strategy.title}</h3>
                            <p style="color: #6b7280; margin-top: 0.5rem;">${strategy.description}</p>
                        </div>
                        <div class="strategy-content">
                            <div class="level-card">
                                <div class="level-header">
                                    <span style="font-size: 1.25rem;">⚡</span>
                                    <h4>Implementation Details</h4>
                                    <span class="gain-badge">+${strategy.efficiencyGain || '25%'}</span>
                                </div>
                                <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.75rem;">
                                    <strong>Tools:</strong> ${strategy.tools}<br>
                                    <strong>Setup:</strong> ${strategy.setupTime} | 
                                    <strong>Weekly Savings:</strong> ${strategy.weeklySavings}
                                </div>
                                <button class="quick-start-btn" onclick="toggleQuickStart(this)">
                                    Implementation Steps ▼
                                </button>
                                <div class="quick-start-content">
                                    ${strategy.steps ? strategy.steps.map(step => `<strong>•</strong> ${step}`).join('<br>') : 'Implementation guide will be provided.'}
                                    ${strategy.quickWin ? `<br><br><strong>Quick Win:</strong> ${strategy.quickWin}` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            // Show monetization CTA
            const totalStrategies = analysis.strategies.length;
            if (totalStrategies > 0) {
                document.getElementById('monetization-title').textContent = 
                    `You've unlocked ${totalStrategies} efficiency improvements!`;
                document.querySelector('.monetization-cta').style.display = 'block';
            }
        }

        function toggleQuickStart(button) {
            const content = button.nextElementSibling;
            const isVisible = content.style.display !== 'none';
            
            if (isVisible) {
                content.style.display = 'none';
                button.innerHTML = 'Implementation Steps ▼';
            } else {
                content.style.display = 'block';
                button.innerHTML = 'Implementation Steps ▲';
            }
        }

        // UI Navigation
        function showFormSection() {
            resultsSection.classList.add('hidden');
            formSection.classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        function showResultsSection() {
            formSection.classList.add('hidden');
            resultsSection.classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        // Auth Functions (keeping existing auth logic)
        function showAuthModal(mode = 'signup') {
            currentAuthMode = mode;
            updateAuthModal();
            authModal.classList.add('show');
            document.getElementById('auth-email').focus();
        }

        function hideAuthModal() {
            authModal.classList.remove('show');
            clearAuthMessages();
            document.getElementById('auth-form').reset();
        }

        function updateAuthModal() {
            const title = document.getElementById('modal-title');
            const subtitle = document.getElementById('modal-subtitle');
            const submit = document.getElementById('auth-submit');
            const toggle = document.getElementById('auth-toggle');

            if (currentAuthMode === 'signup') {
                title.textContent = 'Get Unlimited Access';
                subtitle.textContent = 'Sign up for unlimited job analyses and advanced features';
                submit.textContent = 'Continue Free Forever';
                toggle.innerHTML = 'Already have an account? <a onclick="toggleAuthMode()">Sign in</a>';
            } else {
                title.textContent = 'Welcome Back';
                subtitle.textContent = 'Sign in to access your unlimited analyses';
                submit.textContent = 'Sign In';
                toggle.innerHTML = 'Need an account? <a onclick="toggleAuthMode()">Sign up</a>';
            }
        }

        function toggleAuthMode() {
            currentAuthMode = currentAuthMode === 'signup' ? 'login' : 'signup';
            updateAuthModal();
            clearAuthMessages();
        }

        async function handleAuth(e) {
            e.preventDefault();
            
            const email = document.getElementById('auth-email').value.trim();
            const password = document.getElementById('auth-password').value;

            if (!email || !password) {
                showAuthMessage('Please fill in all fields', 'error');
                return;
            }

            const submitBtn = document.getElementById('auth-submit');
            const originalText = submitBtn.textContent;
            
            try {
                submitBtn.innerHTML = '<div class="spinner"></div>';
                submitBtn.disabled = true;

                let result;
                if (supabase) {
                    if (currentAuthMode === 'signup') {
                        result = await handleSupabaseSignup(email, password);
                    } else {
                        result = await handleSupabaseLogin(email, password);
                    }
                } else {
                    result = await simulateAuth(email, password);
                }

                if (result.success) {
                    if (result.needsVerification) {
                        showAuthMessage('Please check your email and click the confirmation link', 'success');
                    } else {
                        hideAuthModal();
                    }
                } else {
                    showAuthMessage(result.error, 'error');
                }

            } catch (error) {
                console.error('Auth error:', error);
                showAuthMessage('Authentication failed. Please try again.', 'error');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        async function handleSupabaseSignup(email, password) {
            try {
                const { data, error } = await supabase.auth.signUp({
                    email,
                    password,
                    options: { data: { signup_source: 'jobs2course' } }
                });

                if (error) throw error;

                return {
                    success: true,
                    user: data.user,
                    needsVerification: !data.session
                };
            } catch (error) {
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        async function handleSupabaseLogin(email, password) {
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email, password
                });

                if (error) throw error;

                return { success: true, user: data.user };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function simulateAuth(email, password) {
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            const user = {
                id: 'demo-' + Date.now(),
                email: email,
                created_at: new Date().toISOString()
            };

            handleAuthSuccess(user);
            return { success: true, user: user };
        }

        function handleAuthSuccess(user) {
            currentUser = user;
            usageCount = 999;
            
            localStorage.setItem('jobs2course_user', JSON.stringify({
                id: user.id,
                email: user.email,
                authenticated_at: Date.now()
            }));
            
            localStorage.removeItem('jobs2course_usage');
            updateUI();
        }

        async function handleLogout() {
            try {
                if (supabase) {
                    await supabase.auth.signOut();
                }
                handleAuthLogout();
            } catch (error) {
                console.error('Logout error:', error);
                handleAuthLogout();
            }
        }

        function handleAuthLogout() {
            currentUser = null;
            usageCount = 5;
            
            localStorage.removeItem('jobs2course_user');
            localStorage.setItem('jobs2course_usage', '5');
            updateUI();
        }

        async function handleGoogleSignIn() {
            try {
                if (!supabase) {
                    showAuthMessage('Google sign-in not available in demo mode', 'error');
                    return;
                }

                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: { redirectTo: window.location.origin }
                });

                if (error) throw error;
                
            } catch (error) {
                console.error('Google sign-in error:', error);
                showAuthMessage('Google sign-in failed. Please try again.', 'error');
            }
        }

        function showAuthMessage(message, type) {
            const messagesContainer = document.getElementById('auth-messages');
            messagesContainer.innerHTML = `<div class="${type}-message">${message}</div>`;
        }

        function clearAuthMessages() {
            document.getElementById('auth-messages').innerHTML = '';
        }

        // Make functions globally available
        window.showAuthModal = showAuthModal;
        window.hideAuthModal = hideAuthModal;
        window.toggleAuthMode = toggleAuthMode;
        window.handleLogout = handleLogout;
        window.toggleQuickStart = toggleQuickStart;
        window.handleGoogleSignIn = handleGoogleSignIn;
    </script>
</body>
</html>
